<!doctype html>
<html>
	<head>
		<title></title>
		<meta charset="utf-8">
		<meta name="description" content="">
		<meta name="author" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="mobile-web-app-capable" content="yes">
		<base target="_blank" href="../../">
	</head>

	<style>
		:root {
			--top-bar-height: 15em;
		}
		body { margin-top: 3em; color: white;}
		iframe, #iframe-print-button { position: absolute; }
		iframe {
			border: 0; background: white; bottom: 2px; left: 0; right: 0;
			width: 100%; height: calc(100% - var(--top-bar-height));
		}
		#iframe-print-button {top:var(--top-bar-height); right: 1em; filter: invert(1); }
	</style>

	<body>
	</body>

	<script type="module">
		import handlebars from 'https://cdn.skypack.dev/handlebars';
		import { importCSS, consoleHelper, htmlToElement } from './.tools/misc.mjs'
		consoleHelper();
		
		console.log(`
- ins and outs totals
- circle for tickets amount
- make sure dates are right
- make sure things are centered which need be
- map search results row
- cleanup columns disclaimer
- don't break in between grouped rows
- make module
		`);

		(async () => {
			const source = await (await fetch('./handlebars.noms.hbs')).text();
			const css = await (await fetch('./handlebars.css')).text();
			const nomsData = await (await fetch('./handlebars.noms.data.json')).json();
			const nomsPrefs = await (await fetch('./handlebars.noms.prefs.json')).json();

			const searchCriteria = {
				"dayType":"C",
				"includeDeleted":"EXCLUDE",
				"multiSortMeta":[{
					"field":"carrierBatchCode",
					"order":1
				}],
				"rows":100
			};
			
			const userNameMapper = (row) => [
				'carrierConfirmationBy',
				'touchedBy',
				'createdBy',
				'tankageConfirmationBy',
				'shipperConfirmationBy',
				'supplierConsigneeConfirmationBy',
			].forEach((key) => {
				row[key] = row[key] && row[key].fullName ? row[key].fullName : ''
			});
			
			const dateMapper = (row) => {
				const dateKeys = [
					'expirationDate',
					'startDate',
					'stopDate',
					'ticketDate',
					'touchedOn',
					'projectedDate',
					'expirationDate',
					'createdDate',
					'requestedDate',
					'batchCreatedDate',
					'scheduledDate',
					'carrierConfirmationDate',
					'supplierConsigneeConfirmationDate',
					'tankageConfirmationDate',
					'shipperConfirmationDate',
				]
				dateKeys.forEach((x) => {
					try {
						if (!row[x]) return
						const value = row[x]
						let [date, time] = value.toString().split('T')
						if (!date || !time) return
						const [year, month, day] = date.split('-')
						date = [Number(month), Number(day), year.split('').slice(2).join('')].join('/')
						time = time
							.split(':')
							.slice(0, 2)
							.map((x) => Number(x))
						let ampm = 'AM'
						if (time[0] > 12) {
							ampm = 'PM'
							time[0] -= 12
						}
						if (time[0] === 12) {
							ampm = 'PM'
						}
						if (time[0] === 0) {
							time[0] = 12
						}
						time[1] = time[1].toString().padStart(2, '0')
						time = time.join(':')
						if (time === '12:00' && ampm === 'AM') {
							time = ''
							ampm = ''
						}
						row[x] = [date, time, ampm].join(' ')
					} catch (e) {
						console.log(e)
						console.log(`Problem formatting date for ${x} field, value = ${row[x]}`)
					}
					return
				})
			};
			
			const groupNoms = (row, i, all) => {
				if(i>0 && (i==1 || !all[i-1].class?.includes('even'))){
					row.class = row.class || '';
					row.class = [...row.class.split(" "), "even"].join(" ");
				}
				const nextRow = all[i+1];
				if(nextRow && nextRow.carrierBatchCode === row.carrierBatchCode) return;

				let grouped = [];
				for(var n=0; all[i-n] && all[i-n].carrierBatchCode === row.carrierBatchCode ; n++){
					grouped.push(all[i-n]);
				}
				if(grouped.length <= 1) return;

				grouped = grouped.reverse();

				grouped.forEach((g, gi) => {
					const thisClass = new Set(g.class?.split(' ') || []);
					if(grouped[0].class?.includes('even')){
						thisClass.add('even');
					} else {
						thisClass.delete('even');
					}
					g.class = Array.from(thisClass).join(" ");
					gi && (g.isGrouped = true);
				});
				grouped[0].groupLength = grouped.length;
			};

			nomsData.items.forEach((row, i, all) => {
				//console.log(typeof i.tickets)
				userNameMapper(row);
				dateMapper(row);
				groupNoms(row, i, all);
				row.tickets = row.tickets && row.tickets.length ? row.tickets.length : '';
			});
			
			const emptyColumns = (() => {
				const _empty = {};
				const isEmpty = (x) => {
					return x === null ||
						typeof x === 'undefined' ||
						(typeof x === 'string' && !(x.trim()));
				};
				const visibleColumns = nomsPrefs.columns.filter(c => c.selected);
				nomsData.items.forEach(i => {
					Object.keys(i).forEach(key => {
						if(_empty[key] === false) return;

						const someVisibleColumn = visibleColumns.find(col => col.index === key);
						if(!someVisibleColumn) return;
						const emptyValue = isEmpty(i[key]);
						if(!emptyValue){
							_empty[key] = false;
							return;
						}
						_empty[key] = someVisibleColumn;
					})
				});
				return Object.entries(_empty)
					.filter(([k,v]) => v !== false)
					.map(([key,v]) => {
						nomsPrefs.columns.forEach(col => {
							if(col.index !== key) return;
							col.selected = false;
						});
						return v.header
					});
			})();
			
			//console.log('empty columns: ' + emptyColumns)

			
			const data = {
				userCode: 'jCustomer',
				email: 'joe@customer.com',
				cleanSearchCriteria: {
					"Day Type": 'C',
					"Include Deleted": 'EXCLUDE'
				},

				createdDate: '2/9/2021, 12:49:55 PM',
				requestedDate: '2/9/2021, 12:49:55 PM',
				orderBy: 'T4 Batch Code (ASC)',
				
				resultCountDisclaimer: '*** 500 results maximum ***',
				searchResultsUrl: 'htllo',

				columns: nomsPrefs.columns,

				tickets: nomsData.items.filter((x, i) => nomsData.items.length - i > 37), //36, 37
				resultCount: nomsData.items.length,

				summaryColumns: [],
				summaryRows: nomsData.totals,

				emptyColumns: emptyColumns.length && emptyColumns,

				css
			};


			//console.log(Object.keys(nomsData.items[0]))

			handlebars.registerHelper('eq', (arg1, arg2, options) => arg1 === arg2);
			
			var template = handlebars.compile(source);
			var result = template(data);
			//console.log(result.slice(0,100));

			const previewIframe = htmlToElement('<iframe>');
			window.printIframe = () => {
				previewIframe.focus();
				previewIframe.contentWindow.print();
			}
			document.body.append(htmlToElement(`
				<input id="iframe-print-button" type="button" onclick="printIframe()" value="PRINT"/>
			`));
			document.body.append(previewIframe)
			previewIframe.srcdoc = result;

			
		})()
	</script>
</html>
